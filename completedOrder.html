  <!-- Completed Orders -->
  <h3 class="mt-5">Completed Orders</h3>
  <div class="table-responsive">
    <table class="table table-bordered table-striped table-hover">
      <thead class="text-center">
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Payment</th>
          <th>Items</th>
          <th>Total</th>
          <th>Placed</th>
        </tr>
      </thead>
      <tbody>
        <% if (completedOrders && completedOrders.length > 0) { %>
          <% completedOrders.forEach(order => { %>
            <tr>
              <td><%= order._id %></td>
              <td><%= order.user.name %></td>
              <td><%= order.status %></td>
              <td><%= order.paymentMethod %></td>
              <td><%= order.items.map(item => item.product.productName).join(', ') %></td>
              <td>â‚±<%= order.total.toFixed(2) %></td>
              <td><%= order.createdAt.toLocaleDateString() %></td>
            </tr>
          <% }) %>
        <% } else { %>
          <tr>
            <td colspan="7" class="text-center">No completed orders</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>


  //auth controller.js
  const User = require('../models/User');
const Product = require('../models/Product');
const Order = require('../models/Order'); 
const Staff = require('../models/Staff');

// Show login form
exports.showLogin = (req, res) => {
  res.render('login', { error: null });
};

exports.showCart = (req, res) => {
  res.render('cart', { error: null });
};

// Show order history
exports.showOrder = async (req, res) => {
  try {
    const userId = req.session.userId;

    if (!userId) {
      return res.redirect('/login');
    }

    const orders = await Order.find({ userId }).lean();
    res.render('order', {
      orders,
      message: orders.length === 0 ? 'You have no recent orders.' : null
    });
  } catch (err) {
    console.error('Error fetching orders:', err);
    res.render('order', {
      orders: [],
      message: 'Something went wrong while loading your orders.'
    });
  }
};

// Show user profile
exports.showProfile = async (req, res) => {
  try {
    const userId = req.session.userId;

    if (!userId) {
      return res.redirect('/login');
    }

    const user = await User.findById(userId);

    if (!user) {
      return res.redirect('/login');
    }

    res.render('profile', { user, error: null });
  } catch (error) {
    console.error(error);
    res.render('profile', { user: null, error: 'Failed to load user profile.' });
  }
};

// Show registration form
exports.showRegister = (req, res) => {
  res.render('register', { error: req.query.error, success: req.query.success });
};

// Registration function
exports.register = async (req, res) => {
  const { firstName, lastName, phone, address, email, username, password, confirm_password } = req.body;

  if (password !== confirm_password) {
    return res.redirect('/register?error=Passwords do not match');
  }

  try {
    const existingUser = await User.findOne({ $or: [{ email }, { phone }, { username }] });

    if (existingUser) {
      return res.redirect('/register?error=User with this email, phone, or username already exists.');
    }

    const user = new User({ firstName, lastName, phone, address, email, username, password });
    await user.save();

    return res.redirect('/login?success=Registration successful! Please log in.');
  } catch (error) {
    return res.redirect('/register?error=Registration error: ' + encodeURIComponent(error.message));
  }
};

// Login function
exports.login = async (req, res) => {
  const { email, password } = req.body;

  try {
    if (email === 'zerodegreecafe@gmail.com' && password === 'admin12345') {
      req.session.user = { email, role: 'admin' };
      return res.redirect('/admin/index');
    }

    if (email.endsWith('@staff.com')) {
      const staff = await Staff.findOne({ email });
    
      if (!staff || !(await staff.comparePassword(password))) {
        return res.render('login', { error: 'Invalid staff email or password.' });
      }
    
      req.session.user = {
        id: staff._id,
        role: 'staff',
        name: `${staff.s_fname} ${staff.s_lname}`,
        email: staff.email
      };
      return res.redirect('/staff/index');
    }    

    const user = await User.findOne({ email });
    if (!user || !(await user.comparePassword(password))) {
      return res.render('login', { error: 'Invalid email or password.' });
    }

    req.session.userId = user._id;
    req.session.user = user;
    res.redirect('/dashboard');

  } catch (error) {
    res.status(500).render('login', { error: 'Login error: ' + error.message });
  }
};

// Staff routes
exports.staffOrders = async (req, res) => {
  if (!req.session.user || req.session.user.role !== 'staff') {
    return res.redirect('/login');
  }
  const orders = await Order.find().lean();
  res.render('staff/orders', { user: req.session.user, orders });
};

// Staff products route
exports.staffReviews = async (req, res) => {
  if (!req.session.user || req.session.user.role !== 'staff') {
    return res.redirect('/login');
  }

  const reviews = []; 
  res.render('staff/reviews', { user: req.session.user, reviews });
};

// Staff dashboard route
exports.staffDashboard = async (req, res) => {
  if (!req.session.user || !req.session.user.email.endsWith('@staff.com')) {
    return res.redirect('/login');
  }

  try {
    const orders = await Order.find().lean();
    const pendingOrders = orders.filter(order => order.status === 'Pending').length;
    const processingOrders = orders.filter(order => order.status === 'Processing').length;
    const cancelledOrders = orders.filter(order => order.status === 'Cancelled').length;
    const completedOrders = orders.filter(order => order.status === 'Completed').length;
    const products = await Product.find().lean();

    // Calculate total products and out-of-stock products
    const totalProducts = products.length;
    const outOfStockProducts = products.filter(product => product.stock === 0).length;

    // Calculate decreasing stock (if needed)
    const decreasingStock = products.filter(product => product.stock < 5).length;

    // Calculate the total number of products sold (based on order data and product quantity)
    let soldCount = 0;
    orders.forEach(order => {
      order.items.forEach(item => {
        const product = products.find(p => p._id.toString() === item.productId.toString());
        if (product) {
          soldCount += item.quantity;
        }
      });
    });

    res.render('staff/index', {
      user: req.session.user,
      pendingOrders,
      processingOrders,
      cancelledOrders,
      completedOrders,
      totalProducts,
      outOfStockProducts,
      decreasingStock,
      soldCount
    });

  } catch (error) {
    res.status(500).send('Error fetching data for the dashboard');
  }
};

// Admin dashboard route
exports.dashboard = async (req, res) => {
  if (!req.session.user) return res.redirect('/login');

  try {
    const products = await Product.find();

    products.forEach(product => {
      if (!product.productImage) {
        product.productImage = '/images/default.jpg';
      }
    });

    res.render('dashboard', {
      user: req.session.user,
      products: products
    });
  } catch (error) {
    console.error('Error loading dashboard:', error);
    res.render('dashboard', {
      user: req.session.user,
      products: [],
      error: 'Error loading products'
    });
  }
};

// Handle checkout POST
exports.handleCheckout = async (req, res) => {
  try {
    const userId = req.session.userId;
    const cart = req.session.cart;
    const paymentMode = req.body.paymentMode;

    if (!userId) return res.redirect('/login');
    if (!cart || cart.length === 0) return res.redirect('/cart');

    const orderItems = cart.map(item => ({
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      price: item.price,
      total: item.price * item.quantity,
    }));

    const order = new Order({
      user: userId,
      paymentMode,
      items: orderItems,
      totalAmount: orderItems.reduce((sum, item) => sum + item.total, 0),
    });

    await order.save();

    // Clear cart from session after order is placed
    req.session.cart = [];

    res.redirect('/checkout/success');
  } catch (err) {
    console.error('Checkout error:', err.message);
    res.status(500).render('cart', { error: 'Failed to process your order. Please try again.' });
  }
};

// Show order success page
exports.showOrderSuccess = (req, res) => {
  res.render('order-success');
};

exports.handleCheckout = async (req, res) => {
  try {
    const userId = req.session.userId;
    const cart = req.session.cart;
    const paymentMode = req.body.paymentMode;

    if (!userId) return res.redirect('/login');
    if (!cart || cart.length === 0) return res.redirect('/cart');

    const orderItems = cart.map(item => ({
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      price: item.price,
      total: item.price * item.quantity,
    }));

    // Calculate total amount of the order
    const totalAmount = orderItems.reduce((sum, item) => sum + item.total, 0);

    // Create and save the order
    const order = new Order({
      user: userId,
      paymentMode,
      items: orderItems,
      totalAmount,
    });

    // Reduce the stock of products after the order is placed
    for (const item of orderItems) {
      const product = await Product.findById(item.productId);

      // Ensure that the product exists and has enough stock
      if (!product || product.stock < item.quantity) {
        return res.status(400).render('cart', { error: `Not enough stock for ${item.productName}.` });
      }

      // Update product stock
      product.stock -= item.quantity;
      await product.save();
    }

    // Save the order
    await order.save();

    // Clear cart from session after order is placed
    req.session.cart = [];

    res.redirect('/checkout/success');
  } catch (err) {
    console.error('Checkout error:', err.message);
    res.status(500).render('cart', { error: 'Failed to process your order. Please try again.' });
  }
};

// Logout function
exports.logout = (req, res) => {
  req.session.destroy(() => {
    res.redirect('/login');
  });
};



staff// staff controller.js
exports.staffOrders = async (req, res) => {
  if (!req.session.user || req.session.user.role !== 'staff') {
    return res.redirect('/login');
  }

  try {
    // Populate the product details in each item of the order
    const orders = await Order.find()
      .populate('items.productId')  // Populate the product details (productName, price, etc.)
      .lean();  // Use lean() to return plain JavaScript objects (not Mongoose documents)

    // Render the orders page with the populated orders
    res.render('staff/orders', { user: req.session.user, orders });
  } catch (err) {
    console.error(err);
    res.status(500).send('Error retrieving orders');
  }
};

// Staff products route
exports.staffReviews = async (req, res) => {
  if (!req.session.user || req.session.user.role !== 'staff') {
    return res.redirect('/login');
  }

  const reviews = []; 
  res.render('staff/reviews', { user: req.session.user, reviews });
};

// Staff dashboard route
exports.staffDashboard = async (req, res) => {
  if (!req.session.user || !req.session.user.email.endsWith('@staff.com')) {
    return res.redirect('/login');
  }

  try {
    const orders = await Order.find().lean();
    const pendingOrders = orders.filter(order => order.status === 'Pending').length;
    const processingOrders = orders.filter(order => order.status === 'Processing').length;
    const cancelledOrders = orders.filter(order => order.status === 'Cancelled').length;
    const completedOrders = orders.filter(order => order.status === 'Completed').length;
    const products = await Product.find().lean();

    // Calculate total products and out-of-stock products
    const totalProducts = products.length;
    const outOfStockProducts = products.filter(product => product.stock === 0).length;

    // Calculate decreasing stock (if needed)
    const decreasingStock = products.filter(product => product.stock < 5).length;

    // Calculate the total number of products sold (based on order data and product quantity)
    let soldCount = 0;
    orders.forEach(order => {
      order.items.forEach(item => {
        const product = products.find(p => p._id.toString() === item.productId.toString());
        if (product) {
          soldCount += item.quantity;
        }
      });
    });

    res.render('staff/index', {
      user: req.session.user,
      pendingOrders,
      processingOrders,
      cancelledOrders,
      completedOrders,
      totalProducts,
      outOfStockProducts,
      decreasingStock,
      soldCount
    });

  } catch (error) {
    res.status(500).send('Error fetching data for the dashboard');
  }
};